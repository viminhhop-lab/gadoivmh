<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chia và Sao chép Văn bản</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h2 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 20px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #fafafa;
            box-sizing: border-box;
        }
        .text-input-group, .text-output-group {
            margin-bottom: 20px;
        }
        .text-input-group label, .text-output-group label, .controls label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .text-output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-right: 85px;
        }
        .line-count {
            font-size: 14px;
            color: #555;
            font-weight: normal;
        }
        #inputText {
            width: 100%;
            height: 300px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        #linesPerChunk {
            width: 80px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #splitBtn {
            margin-left: auto;
        }
        #splitMessage {
            position: absolute;
            top: 50px;
            right: 0;
            left: 0;
            text-align: center;
            color: #007bff;
            font-size: 14px;
            font-weight: bold;
            display: none;
        }
        .chunk-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .chunk-button {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background-color: #fff;
            color: #666;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .chunk-button:hover {
            background-color: #e2e6ea;
            color: #333;
        }
        .chunk-button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .chunk-button.filled {
            background-color: #28a745;
            color: white;
            border-color: #28a745;
        }
        .chunk-button.filled.active {
            background-color: #ffc107;
            color: #333;
            border-color: #ffc107;
        }
        .text-output-group {
            position: relative;
        }
        .output-box {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            min-height: 50px;
            box-sizing: border-box;
        }
        #outputText2 {
            height: 200px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            resize: vertical;
            background-color: #f9f9f9;
            box-sizing: border-box;
            width: 100%;
        }
        #copyBtn {
            position: absolute;
            top: 30px;
            right: 10px;
            padding: 6px 10px;
            font-size: 14px;
            z-index: 10;
            background-color: #28a745;
        }
        #copyBtn:hover {
            background-color: #218838;
        }
        #pasteBtn {
            position: absolute;
            top: 30px;
            right: 80px;
            padding: 6px 10px;
            font-size: 14px;
            background-color: #17a2b8;
            z-index: 10;
        }
        #pasteBtn:hover {
            background-color: #138496;
        }
        #editBtn {
            position: absolute;
            top: 30px;
            right: 10px;
            padding: 6px 10px;
            font-size: 14px;
            z-index: 10;
            background-color: #ffc107;
            color: #333;
        }
        #editBtn:hover {
            background-color: #e0a800;
        }
        .message-box {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
            text-align: center;
        }
        .right-panel-controls {
            margin-top: 20px;
            text-align: center;
        }
        .merge-group {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .download-buttons {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        #mergeBtn, #mergeIncompleteBtn {
            padding: 10px 20px;
            font-size: 16px;
            margin-left: 0;
        }
        #mergeBtn {
            background-color: #6c757d;
        }
        #mergeBtn:hover {
            background-color: #5a6268;
        }
        #mergeIncompleteBtn {
            background-color: #6c757d;
        }
        #mergeIncompleteBtn:hover {
            background-color: #5a6268;
        }
        /* Style cho phần tải file */
        .file-upload-group {
            margin-bottom: 10px;
        }
        #uploadBtn {
            background-color: #28a745;
            color: white;
            padding: 6px 10px;
            font-size: 14px;
        }
        #uploadBtn:hover {
            background-color: #218838;
        }
        #fileInput {
            display: none;
        }
        #extraInput {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #f9f9f9;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        #extraInput:focus {
            border-color: #007bff;
            background-color: #fff;
            outline: none;
        }

    </style>
</head>
<body>

<div class="container">
    <h2>Ứng dụng Chia và Sao chép/Dán Văn bản</h2>
    <div class="main-grid">
        <div class="panel">
            <h3>Bảng 1: Chia và Sao chép</h3>
            <div class="file-upload-group">
                <label>Tải file văn bản lên:</label>
                <input type="file" id="fileInput" accept=".txt, .srt">
                <button id="uploadBtn">Tải lên (.txt, .srt)</button>
            </div>
            <div class="text-input-group">
                <div class="input-header">
                    <label for="inputText">Hoặc dán văn bản dài vào đây:</label>
                    <span id="lineCountInput" class="line-count">Dòng: 1 / 1</span>
                </div>
                <textarea id="inputText" placeholder="Dán văn bản có nhiều dòng vào đây..."></textarea>
            </div>

            <div class="controls">
                <label for="linesPerChunk">Số dòng mỗi đoạn:</label>
                <input type="number" id="linesPerChunk" value="50" min="1">
                <button id="splitBtn">Chia văn bản</button>
                <div id="splitMessage"></div>
            </div>

            <div class="chunk-list-container">
                <label>Các đoạn văn bản:</label>
                <div id="chunkList1" class="chunk-list"></div>
            </div>

            <div class="text-output-group">
                <div class="text-output-header">
                    <label for="outputText1">Nội dung đoạn được chọn:</label>
                    <span id="lineCount1" class="line-count"></span>
                </div>
                <!-- Thêm ngay dưới #outputText1 -->
                <div id="outputText1" class="output-box"></div>
                <input type="text" id="extraInput" placeholder="Nhập thêm nội dung...">
                <button id="copyBtn" disabled>Sao chép</button>

                <div id="messageBox1" class="message-box"></div>
            </div>
        </div>

        <div class="panel">
            <h3>Bảng 2: Dán và Gộp</h3>
            <div class="chunk-list-container">
                <label>Các đoạn văn bản đã dán:</label>
                <div id="chunkList2" class="chunk-list"></div>
            </div>
            <div class="text-output-group">
                <div class="text-output-header">
                    <label for="outputText2">Nội dung đoạn đang dán:</label>
                    <span id="lineCount2" class="line-count"></span>
                </div>
                <textarea id="outputText2" class="output-box" readonly></textarea>
                <button id="pasteBtn" disabled>Dán từ Clipboard</button>
                <button id="editBtn" disabled>Sửa</button>
                <div id="messageBox2" class="message-box"></div>
            </div>
            
            <div class="right-panel-controls">
                <div class="merge-group">
                    <button id="mergeBtn" disabled>Gộp Tất Cả</button>
                    <div class="download-buttons">
                        <button id="downloadTxtCompleteBtn" disabled>Tải về (.txt)</button>
                        <button id="downloadSrtCompleteBtn" disabled>Tải về (.srt)lỗi</button>
                    </div>
                </div>

                <div class="merge-group">
                    <button id="mergeIncompleteBtn" disabled>Gộp Tùy Ý</button>
                    <div class="download-buttons">
                        <button id="downloadTxtIncompleteBtn" disabled>Tải về (.txt)</button>
                        <button id="downloadSrtIncompleteBtn" disabled>Tải về (.srt)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Tham chiếu đến các phần tử HTML
    const inputTextarea = document.getElementById('inputText');
    const splitButton = document.getElementById('splitBtn');
    const chunkList1Container = document.getElementById('chunkList1');
    const chunkList2Container = document.getElementById('chunkList2');
    const outputText1Div = document.getElementById('outputText1');
    const outputText2area = document.getElementById('outputText2');
    const lineCount1Span = document.getElementById('lineCount1');
    const lineCount2Span = document.getElementById('lineCount2');
    const lineCountInputSpan = document.getElementById('lineCountInput');
    const splitMessageDiv = document.getElementById('splitMessage');
    const copyButton = document.getElementById('copyBtn');
    const pasteButton = document.getElementById('pasteBtn');
    const editButton = document.getElementById('editBtn');
    const mergeButton = document.getElementById('mergeBtn');
    const mergeIncompleteButton = document.getElementById('mergeIncompleteBtn');
    const downloadTxtIncompleteBtn = document.getElementById('downloadTxtIncompleteBtn');
    const downloadSrtIncompleteBtn = document.getElementById('downloadSrtIncompleteBtn');
    const downloadTxtCompleteBtn = document.getElementById('downloadTxtCompleteBtn');
    const downloadSrtCompleteBtn = document.getElementById('downloadSrtCompleteBtn');
    const messageBox1 = document.getElementById('messageBox1');
    const messageBox2 = document.getElementById('messageBox2');
    const linesPerChunkInput = document.getElementById('linesPerChunk');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');

    let textChunks = [];
    let pastedChunks = [];
    let currentChunkIndex2 = -1;
    let isEditing = false;

    // Hàm hiển thị thông báo
    function showMessage(msg, box, type = 'success') {
        box.textContent = msg;
        box.style.display = 'block';
        if (type === 'success') {
            box.style.backgroundColor = '#d4edda';
            box.style.color = '#155724';
        } else {
            box.style.backgroundColor = '#f8d7da';
            box.style.color = '#721c24';
        }
        setTimeout(() => {
            box.style.display = 'none';
        }, 3000);
    }

    // Hàm cập nhật số dòng cho input
    function updateLineCountInput() {
        const text = inputTextarea.value;
        const totalLines = text === '' ? 1 : text.split('\n').length;
        const currentLine = text.substring(0, inputTextarea.selectionStart).split('\n').length;
        lineCountInputSpan.textContent = `Dòng: ${currentLine} / ${totalLines}`;
    }

    // Hàm cập nhật số dòng cho output
    function updateLineCount(divOrTextarea, span) {
        const text = divOrTextarea.value || divOrTextarea.textContent;
        const lines = text.trim() === '' ? 0 : text.split('\n').length;
        span.textContent = `${lines} dòng`;
    }

    // **Hàm lưu dữ liệu vào Local Storage**
    function saveToLocalStorage() {
        const data = {
            inputText: inputTextarea.value,
            textChunks: textChunks,
            pastedChunks: pastedChunks,
            linesPerChunk: linesPerChunkInput.value
        };
        localStorage.setItem('textSplitterData', JSON.stringify(data));
    }

    // **Hàm tải dữ liệu từ Local Storage**
    function loadFromLocalStorage() {
        const dataString = localStorage.getItem('textSplitterData');
        if (dataString) {
            const data = JSON.parse(dataString);
            inputTextarea.value = data.inputText;
            textChunks = data.textChunks;
            pastedChunks = data.pastedChunks;
            linesPerChunkInput.value = data.linesPerChunk;

            // Tái tạo lại giao diện dựa trên dữ liệu đã lưu
            recreateUI();
            showMessage('Đã tải dữ liệu từ lần làm việc trước.', messageBox1);
        }
    }

    // Hàm tái tạo giao diện
    function recreateUI() {
        chunkList1Container.innerHTML = '';
        chunkList2Container.innerHTML = '';
        outputText1Div.textContent = '';
        outputText2area.value = '';
        lineCount1Span.textContent = '';
        lineCount2Span.textContent = '';
        copyButton.disabled = true;
        pasteButton.disabled = true;
        editButton.disabled = true;
        mergeButton.disabled = true;
        mergeIncompleteButton.disabled = true;
        downloadTxtIncompleteBtn.disabled = true;
        downloadSrtIncompleteBtn.disabled = true;
        downloadTxtCompleteBtn.disabled = true;
        downloadSrtCompleteBtn.disabled = true;

        if (textChunks.length === 0) {
            updateLineCountInput();
            return;
        }

        textChunks.forEach((chunk, index) => {
            // Tạo nút cho bảng 1
            const chunkButton1 = document.createElement('button');
            chunkButton1.textContent = `Đoạn ${index + 1}`;
            chunkButton1.className = 'chunk-button';
            chunkButton1.dataset.chunkIndex = index;
            chunkButton1.addEventListener('click', (event) => {
                selectChunk(parseInt(event.target.dataset.chunkIndex));
            });
            chunkList1Container.appendChild(chunkButton1);

            // Tạo nút cho bảng 2
            const chunkButton2 = document.createElement('button');
            chunkButton2.textContent = `Đoạn ${index + 1}`;
            chunkButton2.className = 'chunk-button';
            chunkButton2.dataset.chunkIndex = index;
            if (pastedChunks[index] && pastedChunks[index].trim() !== '') {
                chunkButton2.classList.add('filled');
            }
            chunkButton2.addEventListener('click', (event) => {
                selectChunk(parseInt(event.target.dataset.chunkIndex));
            });
            chunkList2Container.appendChild(chunkButton2);
        });

        if (textChunks.length > 0) {
            selectChunk(0);
        }
        updateLineCountInput();
        checkMergeable();
        checkMergeIncomplete();
    }

    // Hàm chia văn bản
    function splitText() {
        const text = inputTextarea.value;
        const lines = text.split('\n');
        if (lines.length === 0 || text.trim() === '') {
            showMessage("Vui lòng dán văn bản hoặc tải file vào ô trên.", messageBox1, 'error');
            return;
        }

        const linesPerChunk = parseInt(linesPerChunkInput.value, 10);
        if (isNaN(linesPerChunk) || linesPerChunk < 1) {
            showMessage("Số dòng mỗi đoạn phải là một số nguyên dương.", messageBox1, 'error');
            return;
        }

        textChunks = [];
        pastedChunks = [];
        let chunkCount = 0;
        for (let i = 0; i < lines.length; i += linesPerChunk) {
            chunkCount++;
            const chunk = lines.slice(i, i + linesPerChunk).join('\n');
            textChunks.push(chunk);
            pastedChunks.push('');
        }
        recreateUI(); // Gọi hàm tái tạo giao diện
        saveToLocalStorage(); // Lưu lại sau khi chia
        splitMessageDiv.textContent = `Đã chia thành ${textChunks.length} đoạn.`;
        splitMessageDiv.style.display = 'block';
        setTimeout(() => {
            splitMessageDiv.style.display = 'none';
        }, 3000);
    }

    // Hàm chọn đoạn đồng bộ
    function selectChunk(index) {
        document.querySelectorAll('.chunk-button').forEach(btn => btn.classList.remove('active'));
        
        // Cập nhật trạng thái active cho Bảng 1
        const chunkButton1 = chunkList1Container.querySelector(`.chunk-button[data-chunk-index="${index}"]`);
        if (chunkButton1) {
            chunkButton1.classList.add('active');
            outputText1Div.textContent = textChunks[index];
            updateLineCount(outputText1Div, lineCount1Span);
            copyButton.disabled = false;
        }

        // Cập nhật trạng thái active cho Bảng 2
        const chunkButton2 = chunkList2Container.querySelector(`.chunk-button[data-chunk-index="${index}"]`);
        if (chunkButton2) {
            chunkButton2.classList.add('active');
            currentChunkIndex2 = index;
            outputText2area.value = pastedChunks[index];
            updateLineCount(outputText2area, lineCount2Span);
            pasteButton.disabled = false;
            editButton.disabled = pastedChunks[index] === '';
        }
    }


    // Hàm sao chép văn bản
    function copyToClipboard() {
    const extraText = document.getElementById('extraInput').value.trim();
    const mainText = outputText1Div.textContent.trim();
    const combinedText = extraText ? `${extraText} ${mainText}` : mainText;

    if (!combinedText) {
        showMessage("Không có nội dung để sao chép.", messageBox1, 'error');
        return;
    }
    if (navigator.clipboard) {
        navigator.clipboard.writeText(combinedText).then(() => {
            showMessage('Đã sao chép thành công!', messageBox1);
        }).catch(err => {
            console.error('Lỗi khi sao chép:', err);
            showMessage('Lỗi khi sao chép. Vui lòng thử lại.', messageBox1, 'error');
        });
    }
}
    // Hàm dán văn bản
    async function pasteFromClipboard() {
        if (currentChunkIndex2 === -1) {
            showMessage("Vui lòng chọn một đoạn văn bản để dán.", messageBox2, 'error');
            return;
        }
        try {
            const text = await navigator.clipboard.readText();
            pastedChunks[currentChunkIndex2] = text;
            outputText2area.value = text;
            updateLineCount(outputText2area, lineCount2Span);
            
            const currentButton = chunkList2Container.querySelector(`.chunk-button[data-chunk-index="${currentChunkIndex2}"]`);
            if (currentButton) {
                currentButton.classList.add('filled');
            }
            
            editButton.disabled = false;
            checkMergeable();
            checkMergeIncomplete();
            saveToLocalStorage(); // Lưu lại sau khi dán
        } catch (err) {
            console.error('Lỗi khi dán:', err);
            showMessage('Lỗi khi dán. Vui lòng thử lại hoặc cấp quyền truy cập clipboard.', messageBox2, 'error');
        }
    }

    // Hàm xử lý file
    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const fileContent = e.target.result;
            let cleanText;
            
            const fileName = file.name;
            if (fileName.endsWith('.srt')) {
                cleanText = fileContent.replace(/(\d+\n)?\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3}\n?/gm, '').trim();
                showMessage("Đã tải file SRT và lọc văn bản thành công!", messageBox1);
            } else if (fileName.endsWith('.txt')) {
                cleanText = fileContent;
                showMessage("Đã tải file TXT thành công!", messageBox1);
            } else {
                showMessage("Định dạng file không được hỗ trợ. Vui lòng chọn file .txt hoặc .srt.", messageBox1, 'error');
                return;
            }
            
            inputTextarea.value = cleanText;
            updateLineCountInput();
            saveToLocalStorage(); // Lưu lại sau khi tải file
        };
        reader.readAsText(file);
    }
    
    // Hàm chuyển đổi chế độ chỉnh sửa
    function toggleEditMode() {
        isEditing = !isEditing;
        if (isEditing) {
            outputText2area.removeAttribute('readonly');
            editButton.textContent = 'Lưu';
            editButton.style.backgroundColor = '#28a745';
            editButton.style.color = '#fff';
            outputText2area.focus();
        } else {
            outputText2area.setAttribute('readonly', 'readonly');
            pastedChunks[currentChunkIndex2] = outputText2area.value;
            updateLineCount(outputText2area, lineCount2Span);
            editButton.textContent = 'Sửa';
            editButton.style.backgroundColor = '#ffc107';
            editButton.style.color = '#333';
            checkMergeable();
            checkMergeIncomplete();
            saveToLocalStorage(); // Lưu lại sau khi chỉnh sửa
        }
    }

    // Kiểm tra xem có thể gộp tất cả không
    function checkMergeable() {
        const allChunksFilled = pastedChunks.every(chunk => chunk.trim() !== '');
        if (allChunksFilled && pastedChunks.length > 0) {
            mergeButton.disabled = false;
            downloadTxtCompleteBtn.disabled = true;
            downloadSrtCompleteBtn.disabled = true;
        } else {
            mergeButton.disabled = true;
            downloadTxtCompleteBtn.disabled = true;
            downloadSrtCompleteBtn.disabled = true;
        }
    }

    // Hàm kiểm tra xem có thể gộp tùy ý không
    function checkMergeIncomplete() {
        const anyChunkFilled = pastedChunks.some(chunk => chunk.trim() !== '');
        if (anyChunkFilled) {
            mergeIncompleteButton.disabled = false;
            downloadTxtIncompleteBtn.disabled = true;
            downloadSrtIncompleteBtn.disabled = true;
        } else {
            mergeIncompleteButton.disabled = true;
            downloadTxtIncompleteBtn.disabled = true;
            downloadSrtIncompleteBtn.disabled = true;
        }
    }
    
    // Các hàm tải về cho Gộp Tất Cả
    function downloadCompleteTxt() {
        const mergedText = pastedChunks.join('\n'); // Đã thay đổi từ \n\n sang \n
        downloadText(mergedText, 'merged_text.txt');
    }
    
    function downloadCompleteSrt() {
        const srtText = createSrtContent(pastedChunks);
        downloadText(srtText, 'merged_subtitle.srt');
    }

    // Các hàm tải về cho Gộp Tùy Ý
    function downloadIncompleteTxt() {
        const filledChunks = pastedChunks.filter(chunk => chunk.trim() !== '');
        const mergedText = filledChunks.join('\n'); // Đã thay đổi từ \n\n sang \n
        downloadText(mergedText, 'merged_incomplete_text.txt');
    }

    function downloadIncompleteSrt() {
        const filledChunks = pastedChunks.filter(chunk => chunk.trim() !== '');
        const srtText = createSrtContent(filledChunks);
        downloadText(srtText, 'merged_incomplete_subtitle.srt');
    }

    // Hàm gộp tất cả văn bản
    function mergeChunks() {
        if (!mergeButton.disabled) {
            showMessage('Đã gộp tất cả đoạn thành công! Bạn có thể tải file.', messageBox2);
            downloadTxtCompleteBtn.disabled = false;
            downloadSrtCompleteBtn.disabled = false;
        }
    }

    // Hàm gộp các đoạn đã dán (tùy ý)
    function mergeIncompleteChunks() {
        if (!mergeIncompleteButton.disabled) {
            showMessage('Đã gộp các đoạn đã dán thành công! Bạn có thể tải file.', messageBox2);
            downloadTxtIncompleteBtn.disabled = false;
            downloadSrtIncompleteBtn.disabled = false;
        }
    }
    
    // Hàm tạo nội dung file SRT
    function createSrtContent(chunks) {
        let srtContent = "";
        let lineCounter = 1;
        let startTime = 0;
        const duration = 5000;
        const timeFormat = (ms) => {
            const hours = Math.floor(ms / 3600000);
            const minutes = Math.floor((ms % 3600000) / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            const milliseconds = ms % 1000;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')},${String(milliseconds).padStart(3, '0')}`;
        };

        chunks.forEach((chunk) => {
            if (chunk.trim() !== '') {
                const start = timeFormat(startTime);
                const end = timeFormat(startTime + duration);
                srtContent += `${lineCounter}\n`;
                srtContent += `${start} --> ${end}\n`;
                srtContent += `${chunk}\n\n`;
                lineCounter++;
                startTime += duration;
            }
        });
        return srtContent;
    }

    // Hàm tải file
    function downloadText(content, filename) {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Gắn sự kiện cho các nút
    splitButton.addEventListener('click', splitText);
    copyButton.addEventListener('click', copyToClipboard);
    pasteButton.addEventListener('click', pasteFromClipboard);
    mergeButton.addEventListener('click', mergeChunks);
    mergeIncompleteButton.addEventListener('click', mergeIncompleteChunks);
    editButton.addEventListener('click', toggleEditMode);
    
    // Gắn sự kiện tải về
    downloadTxtCompleteBtn.addEventListener('click', downloadCompleteTxt);
    downloadSrtCompleteBtn.addEventListener('click', downloadCompleteSrt);
    downloadTxtIncompleteBtn.addEventListener('click', downloadIncompleteTxt);
    downloadSrtIncompleteBtn.addEventListener('click', downloadIncompleteSrt);

    // Gắn sự kiện cho các nút mới
    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileUpload);
    
    // Gắn sự kiện cho textarea để cập nhật số dòng khi người dùng gõ/dán/nhấp chuột
    inputTextarea.addEventListener('input', () => {
        updateLineCountInput();
        saveToLocalStorage(); // Tự động lưu khi gõ
    });
    inputTextarea.addEventListener('click', updateLineCountInput);
    inputTextarea.addEventListener('keyup', updateLineCountInput);
    
    // Gắn sự kiện cho textarea output 2 để cập nhật số dòng khi chỉnh sửa
    outputText2area.addEventListener('input', () => {
        if (isEditing) {
            updateLineCount(outputText2area, lineCount2Span);
        }
    });
    linesPerChunkInput.addEventListener('change', saveToLocalStorage);

    // Khởi tạo bộ đếm dòng ban đầu và tải dữ liệu khi trang vừa load
    window.addEventListener('load', () => {
        loadFromLocalStorage();
        updateLineCountInput();
    });
</script>
</body>
</html>
